<!DOCTYPE html>
<html>
    <style>
        .output{
            display: flex;
            width: 100%; 
            height: 600px;
            border-color: white;
            padding-top: 10px;
        }
        .box {
            box-sizing: content-box;
            padding-top: 10px;
            padding-left: 5px;
            width: 25%;
            height: 600px;
            background: white;
            scroll-behavior: smooth;
            border: 5px;
            border-color: white;
            overflow: scroll;
            text-overflow: ellipsis;
            font: 1.2em "Fira Sans", sans-serif;
        }
    </style>
    <script src="https://storage.googleapis.com/symbl-web-sdk/latest/symbl.min.js"></script>
<script>
// The setup function calls the WebSocket constructor, initiates the connection to the
// server and sets up all event handlers.
const setup = () => {
    closedCaption = document.getElementById("closedCaption");
    transcripts = document.getElementById("transcripts");
    topics = document.getElementById("topics");
    trackers = document.getElementById("trackers");
    insights = document.getElementById("insights");

    symbl.init({
        //appId: '<your App ID>',
        //appSecret: '<your App Secret>',
	    accessToken: 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IlFVUTRNemhDUVVWQk1rTkJNemszUTBNMlFVVTRRekkyUmpWQ056VTJRelUxUTBVeE5EZzFNUSJ9.eyJodHRwczovL3BsYXRmb3JtLnN5bWJsLmFpL3VzZXJJZCI6IjU0MDY2MTkxOTUxNDYyNDAiLCJpc3MiOiJodHRwczovL2RpcmVjdC1wbGF0Zm9ybS5hdXRoMC5jb20vIiwic3ViIjoiMjM4dENVak4zS3I4bDJoV21YdGJueTFQdExxRmpjRVNAY2xpZW50cyIsImF1ZCI6Imh0dHBzOi8vcGxhdGZvcm0ucmFtbWVyLmFpIiwiaWF0IjoxNjM3NzkzMjA2LCJleHAiOjE2Mzc4Nzk2MDYsImF6cCI6IjIzOHRDVWpOM0tyOGwyaFdtWHRibnkxUHRMcUZqY0VTIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIn0.F4FLua8nXV5FBtBhuLagOjrvOERvtuc6oRpo2VjeR0eNoLhx3KhfxdhyRvXqABMl-rtyHUTG7dYkU4BLQu6IUCMpOqNtc3R548r5mKjLod9BbmQ2aJqfOdAZdKOo6KwcrY4gbomlvk4uozeqBT61-QGmh30akJqxPtKs3J9NAxW0y8kogAC6SbpTsAstwzu-anJjCj7FjnIyGuscTWjgfoHH_CSHM1rfJURJ1F9ZQ6GU0cmX1X37I3PP774pPPKC6hDv7JUxbHJ3n4V0L2Vppyu6a8092cFmwnZ2U4y1vA7_NnAmmwPy6U-vOIgP7R7pj9uhX5WttdDmiudfYXJOSg', // can be used instead of appId and appSecret
	    // basePath: '<your custom base path (optional)>',
    });
    
    const id = btoa("symbl-ai-is-the-best");

    const connectionConfig = {
        id,
        insightTypes: ['action_item', 'question'],
        config: {
            meetingTitle: 'My Test Meeting ' + id,
            confidenceThreshold: 0.7,
            timezoneOffset: 480, // Offset in minutes from UTC
            languageCode: 'en-US',
            sampleRateHertz: new AudioContext().sampleRate,
            trackers: [
                {
                    name: "Goodness",
                    vocabulary: [
                        "This is awesome",
                        "I like it",
                        "I love this"
                    ]
                }
            ]
        },
        speaker: {
            // Optional, if not specified, will simply not send an email in the end.
            userId: 'marcelo@symbl.ai', // Update with valid email
            name: 'Marcelo'
        },
        handlers: {
            /**
            * This will return live speech-to-text transcription of the call.
            */
            onSpeechDetected: (data) => {
            if (data) {
                const {punctuated} = data
                console.log('Live: ', punctuated && punctuated.transcript)
                log(punctuated.transcript, closedCaption);
            }
            // console.log('onSpeechDetected ', JSON.stringify(data, null, 2));
            },
            /**
            * When processed messages are available, this callback will be called.
            */
            onMessageResponse: (data) => {
                console.log('onMessageResponse', JSON.stringify(data, null, 2))
                for(let message of data){
                    log(message.payload.content, transcripts);
                }
            },
            /**
            * When Symbl detects an insight, this callback will be called.
            */
            onInsightResponse: (data) => {
            // console.log('onInsightResponse', JSON.stringify(data, null, 2))
                for(let insight of data){
                    const type = insight.type.replace("_", " ");
                    log(type.charAt(0).toUpperCase() + type.slice(1) + ": " + insight.payload.content, insights);
                }
            },
            /**
            * When Symbl detects a topic, this callback will be called.
            */
            onTopicResponse: (data) => {
            // console.log('onTopicResponse', JSON.stringify(data, null, 2))
                t = '';
                for(let topic of data){
                    t = topic.phrases + ", " + t; 
                }
                log(t, topics);
            },
            onDataReceived: (data) => {
                console.log('onDataReceived', JSON.stringify(data, null, 2))
            },
            onTrackerResponse: (data) => {
                // When a tracker is detected in real-time
                console.log('onTrackerResponse', JSON.stringify(data, null, 2));
                for(let tracker of data){
                    log(tracker.name + ': ' + tracker.matches[0].messageRefs[0].text, trackers);
                }
                if (!!data) {
                    data.forEach((tracker) => {
                        console.log(`Detected Tracker Name: ${tracker.name}`);
                        console.log(`Detected Matches`);
                        tracker.matches.forEach((match) => {
                            console.log(`Tracker Value: ${match.value}`);
                            console.log(`Messages detected against this Tracker`);
                            match.messageRefs.forEach((messageRef) => {
                                console.log(`Message ID: ${messageRef.id}`);
                                console.log(`Message text for which the match was detected: ${messageRef.text}`);
                                console.log(`\n`);
                            });
                            console.log(`\n\n`);
                            
                            console.log(`Insights detected against this Tracker`);
                            match.messageRefs.forEach((insightRef) => {
                                console.log(`Insight ID: ${insightRef.id}`);
                                console.log(`Insight text for which the match was detected: ${insightRef.text}`);
                                console.log(`Insight Type: ${insightRef.type}`);
                                console.log(`\n`);
                            });
                            console.log(`\n\n`);
                        });
                    });
                }
            }
        }
    };

    (async () => {
        const connection = await symbl.startRealtimeRequest(connectionConfig, true);
    })();

    // Display Trackers
        //TO DO
        /*
        if(data.type === 'tracker_response'){
            console.log(data.trackers);
            for(let tracker of data.trackers){
                log(tracker.name + ': ' + tracker.matches[0].messageRefs[0].text, trackers);
            }
        }
        */
}
// The log function writes to the web page based on the events that are happening
// and the data passed as an argument to the function
const log = (info, where) => {
	//Display information on screen
	var p = document.createElement("p");
	p.style.wordWrap = "break-word";
	p.innerHTML = info;
    if(where === closedCaption){
        document.getElementById("closedCaption").innerHTML = "";
    } else if(where === topics){
        document.getElementById("topics").innerHTML = "";
    }
    where.appendChild(p);    
    updateScroll(where);
}
/*** 
 * Auto scrolling
 */
const updateScroll = (where) => {
    where.scrollTop = where.scrollHeight;
}

// The window.addEventListener triggers when the web page is loaded 
// then call the setup function window.addEventListener("load", setup, false);
//window.addEventListener("load", setup, false);

// Stop the Websocket connection
const stopConnection = () => {
    symbl.stopRequest();
}
</script>
<body>
<h2 style="font: 1.2em 'Fira Sans', sans-serif;">Simple Symbl Web SDK Client</h2>
<div id="controls">
    <!-- <button type="button" onclick="setupAudio()">Start</button> -->
    <button type="button" onclick="setup()">Start</button>
    <button type="button" onclick="stopConnection()">Stop</button>
</div>
<div class="output" style="height: 50px;">
    <div class="box" style="height: 50px;overflow: hidden;"><h3 align="center">Transcripts</h3></div>
    <div class="box" style="height: 50px;overflow: hidden;"><h3 align="center">Trackers</h3></div>
    <div class="box" style="height: 50px;overflow: hidden;"><h3 align="center">Insights</h3></div>
    <div class="box" style="height: 50px;overflow: hidden;"><h3 align="center">Topics</h3></div>
</div>
<!-- The output div is used as a container for all information we want to write to the screen -->
<div class="output">
    <div id="transcripts" class="box" style="background: hsl(229, 19%, 84%);"></div>
    <div id="trackers" class="box" style="background: rgb(135, 151, 223);"></div>
    <div id="insights" class="box" style="background: hsl(229, 19%, 84%);"></div>
    <div id="topics" class="box" style="background: rgb(135, 151, 223);"></div></div>
</div>
<div>
    <div id="closedCaption" class="box" style="padding-top: 30px;width: 100%;height: 100px;background: black;color: white;">Closed Captions...</div>
</div>
</body>
</html>